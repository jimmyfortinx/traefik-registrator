services:
  consul:
    image: hashicorp/consul:1.20
    command: agent -dev -client=0.0.0.0
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 5s
      timeout: 3s
      retries: 20

  webdocker:
    image: traefik/whoami:v1.11
    labels:
      traefik.enable: "true"
      traefik.http.routers.webdocker.rule: Host(`webdocker.local`)

  webfile:
    image: traefik/whoami:v1.11

  # Use a named volume instead of a host bind mount so this scenario works on macOS
  # when compose tests run from inside a container (no host file-sharing path issues).
  # We seed routes.yml here so registrator-file has file-mode config available at startup
  # and verify can mutate the same file later to assert fs-event based updates.
  seed-file-config:
    image: python:3.13-alpine
    volumes:
      - file-routes:/fixtures/services.d
    command:
      - /bin/sh
      - -ec
      - |
        cat > /fixtures/services.d/routes.yml <<'YAML'
        services:
          webfile:
            address: webfile
            port: 80
            tags:
              - traefik.enable=true
              - traefik.http.routers.webfile.rule=Host(`webfile.local`)
        YAML
        tail -f /dev/null

  registrator-docker:
    image: traefik-registrator:test
    build:
      context: ../..
    depends_on:
      consul:
        condition: service_healthy
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      POLL_INTERVAL: 2s
      GC_INTERVAL: 2s
      OWNER_ID: hybrid-docker-owner
      ORPHAN_GRACE_PERIOD: 20s
      OWNER_DOWN_GRACE_PERIOD: 20s
      SERVICE_ID_PREFIX: docker-
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  registrator-file:
    image: traefik-registrator:test
    build:
      context: ../..
    depends_on:
      consul:
        condition: service_healthy
      seed-file-config:
        condition: service_started
    environment:
      SOURCE_MODE: file
      FILE_SOURCE_PATH: /etc/traefik-registrator/services.d
      CONSUL_HTTP_ADDR: http://consul:8500
      POLL_INTERVAL: 1h
      GC_INTERVAL: 2s
      OWNER_ID: hybrid-file-owner
      ORPHAN_GRACE_PERIOD: 20s
      OWNER_DOWN_GRACE_PERIOD: 20s
      SERVICE_ID_PREFIX: file-
    volumes:
      - file-routes:/etc/traefik-registrator/services.d:ro

  verify:
    image: python:3.13-alpine
    depends_on:
      consul:
        condition: service_healthy
      registrator-docker:
        condition: service_started
      registrator-file:
        condition: service_started
      seed-file-config:
        condition: service_started
      webdocker:
        condition: service_started
      webfile:
        condition: service_started
    volumes:
      - file-routes:/fixtures/services.d
    command:
      - python
      - -c
      - |
        import json
        import time
        import urllib.request

        consul = "http://consul:8500"
        yaml_path = "/fixtures/services.d/routes.yml"

        def load_services():
            with urllib.request.urlopen(consul + "/v1/agent/services", timeout=3) as resp:
                return json.load(resp)

        def managed_services(all_services):
            out = []
            for svc in all_services.values():
                meta = svc.get("Meta", {})
                if meta.get("managed-by") != "traefik-registrator":
                    continue
                if meta.get("kind") == "owner-heartbeat":
                    continue
                out.append(svc)
            return out

        def find_service(all_services, service_id):
            for svc in all_services.values():
                if svc.get("ID") == service_id:
                    return svc
            return None

        deadline = time.time() + 90
        docker_ready = False
        file_ready = False
        last = None

        while time.time() < deadline:
            try:
                last = load_services()
            except Exception:
                time.sleep(1)
                continue

            managed = managed_services(last)
            docker_ready = any(
                svc.get("Meta", {}).get("owner-id") == "hybrid-docker-owner"
                and svc.get("Service") == "webdocker"
                for svc in managed
            )

            file_svc = find_service(last, "file-webfile")
            if file_svc:
                tags = set(file_svc.get("Tags", []))
                file_ready = (
                    file_svc.get("Service") == "webfile"
                    and file_svc.get("Address") == "webfile"
                    and file_svc.get("Port") == 80
                    and file_svc.get("Meta", {}).get("owner-id") == "hybrid-file-owner"
                    and "traefik.http.routers.webfile.rule=Host(`webfile.local`)" in tags
                )

            if docker_ready and file_ready:
                break
            time.sleep(1)

        if not (docker_ready and file_ready):
            print("hybrid-docker-file scenario failed at initial registration")
            print(json.dumps(last, indent=2))
            raise SystemExit(1)

        # Trigger fsnotify path by editing file-backed YAML and expect Consul tags to update.
        original_content = open(yaml_path, "r", encoding="utf-8").read()
        try:
            updated_content = original_content.replace("webfile.local", "webfile-updated.local")
            with open(yaml_path, "w", encoding="utf-8") as f:
                f.write(updated_content)

            deadline = time.time() + 45
            updated = False
            while time.time() < deadline:
                try:
                    last = load_services()
                except Exception:
                    time.sleep(1)
                    continue

                file_svc = find_service(last, "file-webfile")
                docker_ok = any(
                    svc.get("Meta", {}).get("owner-id") == "hybrid-docker-owner"
                    and svc.get("Service") == "webdocker"
                    for svc in managed_services(last)
                )
                if not file_svc or not docker_ok:
                    time.sleep(1)
                    continue

                tags = set(file_svc.get("Tags", []))
                if (
                    "traefik.http.routers.webfile.rule=Host(`webfile-updated.local`)" in tags
                    and "traefik.http.routers.webfile.rule=Host(`webfile.local`)" not in tags
                ):
                    updated = True
                    break
                time.sleep(1)

            if not updated:
                print("hybrid-docker-file scenario failed waiting for file change propagation")
                print(json.dumps(last, indent=2))
                raise SystemExit(1)
        finally:
            with open(yaml_path, "w", encoding="utf-8") as f:
                f.write(original_content)

        print("hybrid-docker-file scenario passed")

volumes:
  file-routes:
