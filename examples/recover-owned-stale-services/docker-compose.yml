services:
  consul:
    image: hashicorp/consul:1.20
    command: agent -dev -client=0.0.0.0
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 5s
      timeout: 3s
      retries: 20

  whoami:
    image: traefik/whoami:v1.11
    labels:
      traefik.enable: "true"
      traefik.http.services.whoami.loadbalancer.server.port: "80"

  seed-stale:
    image: python:3.13-alpine
    depends_on:
      consul:
        condition: service_healthy
    command:
      - python
      - -c
      - |
        import json
        import time
        import urllib.request

        consul = "http://consul:8500"

        def wait_for_consul():
            deadline = time.time() + 30
            while time.time() < deadline:
                try:
                    with urllib.request.urlopen(consul + "/v1/status/leader", timeout=3) as resp:
                        leader = resp.read().decode().strip().strip('"')
                        if leader:
                            return
                except Exception:
                    pass
                time.sleep(1)
            raise RuntimeError("consul did not become ready")

        def register_stale(service_id):
            payload = {
                "ID": service_id,
                "Name": "whoami",
                "Address": "10.250.1.10",
                "Port": 8080,
                "Meta": {
                    "managed-by": "traefik-registrator",
                    "owner-id": "live-owner",
                },
            }
            req = urllib.request.Request(
                consul + "/v1/agent/service/register",
                data=json.dumps(payload).encode("utf-8"),
                method="PUT",
                headers={"Content-Type": "application/json"},
            )
            with urllib.request.urlopen(req, timeout=5) as resp:
                if resp.status != 200:
                    raise RuntimeError(f"seed register failed for {service_id}: status={resp.status}")

        wait_for_consul()
        register_stale("stale-whoami-a")
        register_stale("stale-whoami-b")
        print("seeded stale owner-bound services")
        while True:
            time.sleep(60)

  startup-gate:
    image: alpine:3.21
    command:
      - /bin/sh
      - -ec
      - |
        sleep 8
        touch /tmp/ready
        tail -f /dev/null
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/ready"]
      interval: 1s
      timeout: 1s
      retries: 20

  registrator:
    image: traefik-registrator:test
    build:
      context: ../..
    depends_on:
      consul:
        condition: service_healthy
      seed-stale:
        condition: service_started
      startup-gate:
        condition: service_healthy
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      POLL_INTERVAL: 2s
      GC_INTERVAL: 2s
      OWNER_ID: live-owner
      ORPHAN_GRACE_PERIOD: 2m
      OWNER_DOWN_GRACE_PERIOD: 2m
      SERVICE_ID_PREFIX: docker-
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  verify:
    image: python:3.13-alpine
    depends_on:
      consul:
        condition: service_healthy
      seed-stale:
        condition: service_started
      whoami:
        condition: service_started
    command:
      - python
      - -c
      - |
        import json
        import time
        import urllib.parse
        import urllib.request

        consul = "http://consul:8500"
        stale_ids = {"stale-whoami-a", "stale-whoami-b"}
        owner_service = "traefik-registrator-owner"

        def consul_json(path):
            with urllib.request.urlopen(consul + path, timeout=3) as resp:
                return json.load(resp)

        def agent_services():
            return consul_json("/v1/agent/services")

        def whoami_instances():
            encoded = urllib.parse.quote("whoami", safe="")
            return consul_json(f"/v1/catalog/service/{encoded}")

        def owner_states():
            encoded = urllib.parse.quote(owner_service, safe="")
            checks = consul_json(f"/v1/health/checks/{encoded}")
            states = {}
            for check in checks:
                service_id = (check.get("ServiceID") or "").strip()
                if not service_id.startswith("traefik-registrator-owner-"):
                    continue
                owner = service_id[len("traefik-registrator-owner-"):].strip()
                if owner:
                    states[owner] = (check.get("Status") or "").strip()
            return states

        def wait_until(description, predicate, timeout):
            deadline = time.time() + timeout
            last = None
            while time.time() < deadline:
                try:
                    result = predicate()
                    if result is True:
                        return
                    last = result
                except Exception as err:
                    last = str(err)
                time.sleep(1)
            raise RuntimeError(f"timeout waiting for {description}; last={last}")

        def stale_present_initially():
            services = agent_services()
            if stale_ids.issubset(set(services.keys())):
                return True
            return {"agent_services": sorted(services.keys())}

        wait_until("seeded stale services to exist", stale_present_initially, timeout=30)

        def stale_recovered():
            services = agent_services()
            instances = whoami_instances()
            states = owner_states()

            ids = set(services.keys())
            if ids.intersection(stale_ids):
                return {
                    "reason": "stale ids still in agent/services",
                    "stale_present": sorted(ids.intersection(stale_ids)),
                }

            instance_ids = {item.get("ServiceID") for item in instances}
            if instance_ids.intersection(stale_ids):
                return {
                    "reason": "stale ids still in catalog/service/whoami",
                    "stale_present": sorted(instance_ids.intersection(stale_ids)),
                }

            live_ids = []
            for sid, svc in services.items():
                meta = svc.get("Meta", {})
                if meta.get("managed-by") != "traefik-registrator":
                    continue
                if meta.get("kind") == "owner-heartbeat":
                    continue
                if meta.get("owner-id") != "live-owner":
                    continue
                if not sid.startswith("docker-"):
                    continue
                live_ids.append(sid)

            if not live_ids:
                return {
                    "reason": "no live owner-managed docker-* service found",
                    "agent_services": sorted(services.keys()),
                }

            if states.get("live-owner") != "passing":
                return {"reason": "owner heartbeat not passing", "states": states}

            return True

        wait_until("registrator to reconcile stale owner services", stale_recovered, timeout=90)
        print("recover-owned-stale-services scenario passed")
