services:
  consul:
    image: hashicorp/consul:1.20
    command: agent -dev -client=0.0.0.0
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 5s
      timeout: 3s
      retries: 20

  whoami:
    image: traefik/whoami:v1.11
    labels:
      traefik.enable: "true"
      traefik.http.services.whoami.loadbalancer.server.port: "80"

  seed-stale:
    image: python:3.13-alpine
    depends_on:
      consul:
        condition: service_healthy
    command:
      - python
      - -c
      - |
        import json
        import time
        import urllib.request

        consul = "http://consul:8500"

        def wait_for_consul():
            deadline = time.time() + 30
            while time.time() < deadline:
                try:
                    with urllib.request.urlopen(consul + "/v1/status/leader", timeout=3) as resp:
                        leader = resp.read().decode().strip().strip('"')
                        if leader:
                            return
                except Exception:
                    pass
                time.sleep(1)
            raise RuntimeError("consul did not become ready")

        def register_stale(service_id):
            payload = {
                "ID": service_id,
                "Name": "whoami",
                "Address": "10.250.1.10",
                "Port": 8080,
                "Meta": {
                    "managed-by": "traefik-registrator",
                    "owner-id": "live-owner",
                },
            }
            req = urllib.request.Request(
                consul + "/v1/agent/service/register",
                data=json.dumps(payload).encode("utf-8"),
                method="PUT",
                headers={"Content-Type": "application/json"},
            )
            with urllib.request.urlopen(req, timeout=5) as resp:
                if resp.status != 200:
                    raise RuntimeError(f"seed register failed for {service_id}: status={resp.status}")

        wait_for_consul()
        register_stale("stale-whoami-a")
        register_stale("stale-whoami-b")
        print("seeded stale owner-bound services")
        while True:
            time.sleep(60)

  startup-gate:
    image: alpine:3.21
    command:
      - /bin/sh
      - -ec
      - |
        sleep 8
        touch /tmp/ready
        tail -f /dev/null
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/ready"]
      interval: 1s
      timeout: 1s
      retries: 20

  registrator:
    image: traefik-registrator:test
    build:
      context: ../..
    depends_on:
      consul:
        condition: service_healthy
      seed-stale:
        condition: service_started
      startup-gate:
        condition: service_healthy
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      POLL_INTERVAL: 2s
      GC_INTERVAL: 2s
      OWNER_ID: live-owner
      ORPHAN_GRACE_PERIOD: 2m
      OWNER_DOWN_GRACE_PERIOD: 2m
      SERVICE_ID_PREFIX: docker-
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

